FROM hokiegeek2/udp-arkouda-server-base:0.2.0

ADD src/ /opt/src
ADD Makefile /opt/Makefile
ADD dep/ /opt/dep
WORKDIR /opt

ADD start-arkouda-server.sh /opt/start-arkouda-server.sh
ADD start-arkouda-locale.sh /opt/start-arkouda-locale.sh

ENV SSH_SERVERS=0.0.0.0
ENV GASNET_MASTERIP=0.0.0.0

RUN sudo chown -R ubuntu:ubuntu /opt
RUN make install-deps

RUN ssh-keygen -t rsa -N '' -f ~/.ssh/id_rsa
RUN cat ~/.ssh/id_rsa.pub > ~/.ssh/authorized_keys

RUN sudo chown -R ubuntu:ubuntu /opt
RUN sudo service ssh start && make

EXPOSE 5555
EXPOSE 5000-65000/udp

ARG ARKOUDA_DIST_FOLDER=${ARKOUDA_DIST_FOLDER}
ENV ARKOUDA_DIST_FOLDER=${ARKOUDA_DIST_FOLDER}

ADD arkouda.tar.gz /opt/
RUN mv /opt/$ARKOUDA_DIST_FOLDER /opt/client
WORKDIR /opt/client

RUN python3 -m pip install --upgrade pip
RUN python3 -m pip install -e .

WORKDIR /opt

RUN rm -rf ~/.ssh/

ENTRYPOINT sh /opt/start-arkouda-server.sh
