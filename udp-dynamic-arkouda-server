FROM hokiegeek2/udp-arkouda-server-base:0.2.0

ADD src/ /opt/src
ADD Makefile /opt/Makefile
ADD dep/ /opt/dep
WORKDIR /opt

ADD start-arkouda-server.sh /opt/start-arkouda-server.sh
ADD start-arkouda-locale.sh /opt/start-arkouda-locale.sh

ENV SSH_SERVERS=0.0.0.0
ENV GASNET_MASTERIP=0.0.0.0

RUN sudo chown -R ubuntu:ubuntu /opt
RUN make install-deps

RUN sudo chown -R ubuntu:ubuntu /home/ubuntu
ADD ssh_credentials/id_rsa /home/ubuntu/.ssh/id_rsa
ADD ssh_credentials/id_rsa /home/ubuntu/.ssh/id_rsa.pub
ADD ssh_credentials/authorized_keys /home/ubuntu/.ssh/authorized_keys
RUN sudo chown -R ubuntu:ubuntu /home/ubuntu/.ssh

RUN sudo chown -R ubuntu:ubuntu /opt
RUN sudo service ssh start && make

EXPOSE 5555
EXPOSE 5000-65000/udp

ARG ARKOUDA_VERSION=${ARKOUDA_VERSION}
ENV ARKOUDA_VERSION=${ARKOUDA_VERSION}

ADD arkouda.tar.gz /opt/
RUN mv /opt/$ARKOUDA_VERSION /opt/client
WORKDIR /opt/client

RUN python3 -m pip install --upgrade pip
RUN python3 -m pip install -e .

WORKDIR /opt

RUN rm -rf ~/.ssh/

ENTRYPOINT sh /opt/start-arkouda-server.sh
